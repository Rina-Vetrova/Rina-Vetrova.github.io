<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <style>
    body { 
      margin: 0; 
      font-family: Arial, sans-serif; 
      overflow: hidden;
      background: #f5f5f5;
    }
    
    #canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      cursor: crosshair;
    }
    
    #toolsPanel {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 250px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    #toolsPanel.hidden {
      transform: translateX(270px);
      opacity: 0;
    }
    
    #toolsHeader {
      padding: 15px;
      background: #333;
      color: white;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    #toolsContent {
      padding: 15px;
      max-height: 70vh;
      overflow-y: auto;
    }
    
    #toggleBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: #333;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    #toggleBtn:hover {
      background: #555;
      transform: scale(1.1);
    }
    
    #toggleBtn.panelOpen {
      right: 290px;
    }
    
    button {
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    button.active {
      background: #28a745;
    }
    
    textarea {
      width: 100%;
      height: 100px;
      margin: 5px 0;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
    }
    
    label {
      display: block;
      margin: 10px 0 5px 0;
      font-weight: bold;
      font-size: 14px;
    }
    
    hr {
      margin: 15px 0;
      border: none;
      border-top: 1px solid #eee;
    }
    
    #log {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 11px;
      white-space: pre;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
    }
    
    .control-point {
      cursor: grab;
      transition: all 0.2s ease;
    }
    
    .control-point:hover {
      r: 7;
      fill: #dc3545;
    }
    
    .control-point:active {
      cursor: grabbing;
    }
    
    .helper-line {
      stroke: #999;
      stroke-width: 1;
      stroke-dasharray: 3,3;
      opacity: 0.6;
    }
    
    #modeSelector {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    #modeSelector button {
      flex: 1;
      font-size: 12px;
      padding: 8px 4px;
    }
  </style>
</head>
<body>

    <svg id="canvas" width="600" height="400"></svg>

    <button id="toggleBtn">‚ò∞</button>

    <div id="toolsPanel" class="hidden">
        <div id="toolsHeader">
            <span>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</span>
            <span style="cursor: pointer;" onclick="togglePanel()">√ó</span>
        </div>

        <div id="toolsContent">
            <div id="modeSelector">
                <button class="mode-button" data-mode="M">Move (M)</button>
                <button class="mode-button" data-mode="L">Line (L)</button>
                <button class="mode-button" data-mode="Q">Quadratic Bezier (Q)</button>
                <button class="mode-button" data-mode="C">Cubic Bezier (C)</button>
            </div>

            <button id="insertImage">üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω</button>
            <button id="toggleBgControl">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ–Ω–æ–º</button>
            <button id="clearPath">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>

            <button id="undo">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å</button>

            <hr>
            <label>SVG –∫–æ–¥:</label>
            <div id="log"></div>
        </div>
    </div>


    <script>
        (() => {
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
            const canvas = document.getElementById('canvas');
            const toolsPanel = document.getElementById('toolsPanel');
            const toggleBtn = document.getElementById('toggleBtn');
            const modeButtons = document.querySelectorAll('.mode-button');
            const insertImageButton = document.getElementById('insertImage');
            const toggleBgControlButton = document.getElementById('toggleBgControl');
            const clearPathButton = document.getElementById('clearPath');
            const undoButton = document.getElementById('undo');
            const logEl = document.getElementById('log');

            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            let currentMode = 'M';
            let segments = [];
            let isDraggingPanel = false;
            let panelOffsetX, panelOffsetY;
            let isControllingBackground = false;
            let bgImage = null; // –ë—É–¥–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏

            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã SVG
            let svgNS = "http://www.w3.org/2000/svg";
            let svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.setAttribute('style', 'position:absolute; top:0; left:0;');
            canvas.appendChild(svg); // –î–æ–±–∞–≤–ª—è–µ–º SVG –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

            let pathEl = document.createElementNS(svgNS, "path");
            pathEl.setAttribute('id', 'path');
            pathEl.setAttribute('d', '');
            svg.appendChild(pathEl);

            let controlPointsGroup = document.createElementNS(svgNS, "g");
            controlPointsGroup.setAttribute('id', 'control-points');
            svg.appendChild(controlPointsGroup);

            let helperLinesGroup = document.createElementNS(svgNS, "g");
            helperLinesGroup.setAttribute('id', 'helper-lines');
            svg.appendChild(helperLinesGroup);

           // –°–æ–∑–¥–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º bgImage –≤ SVG
            let bgImage = document.createElementNS(svgNS, "image");
            bgImage.setAttribute('id', 'bgImage');
            svg.appendChild(bgImage);

            function createBgImage(){
                bgImage = document.createElementNS(svgNS, "image");
                bgImage.setAttribute('id', 'bgImage');
                bgImage.setAttribute('x', '0'); // –ù–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
                bgImage.setAttribute('y', '0');
                bgImage.setAttribute('z-index', '1');
                svg.appendChild(bgImage);
            }
            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç–µ–º –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏

              const commandHandlers = {
                'M': (ctx, s) => s.pts.forEach(pt => { ctx.moveTo(pt.x, pt.y); createControlPoint(pt); }),
                'L': (ctx, s) => s.pts.forEach(pt => { ctx.lineTo(pt.x, pt.y); createControlPoint(pt); }),

                'Q': (ctx, s) => {
                  ctx.quadraticCurveTo(s.pts[1].x, s.pts[1].y, s.pts[2].x, s.pts[2].y);
                   createControlPoint(s.pts[0]); // –ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
                    createControlPoint(s.pts[1], 'control'); // –ü–µ—Ä–≤–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
                    createControlPoint(s.pts[2]); // –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞
                    createHelperLine(s.pts[0], s.pts[1]); // –õ–∏–Ω–∏—è –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –∫ –ø–µ—Ä–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π
                    createHelperLine(s.pts[1], s.pts[2]); // –õ–∏–Ω–∏—è –æ—Ç –ø–µ—Ä–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –∫ –∫–æ–Ω–µ—á–Ω–æ–π
                },
                'C': (ctx, s) => {
                  ctx.bezierCurveTo(s.pts[1].x, s.pts[1].y, s.pts[2].x, s.pts[2].y, s.pts[3].x, s.pts[3].y);
                    createControlPoint(s.pts[0]); // –ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
                    createControlPoint(s.pts[1], 'control'); // –ü–µ—Ä–≤–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
                    createControlPoint(s.pts[2], 'control'); // –í—Ç–æ—Ä–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
                    createControlPoint(s.pts[3]); // –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞
                    createHelperLine(s.pts[0], s.pts[1]); // –õ–∏–Ω–∏—è –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –∫ –ø–µ—Ä–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π
                    createHelperLine(s.pts[2], s.pts[3]); // –õ–∏–Ω–∏—è –æ—Ç –≤—Ç–æ—Ä–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –∫ –∫–æ–Ω–µ—á–Ω–æ–π
                }
              };
            function redraw() {
                let d = '';
                clearControlPoints();

                segments.forEach(s => {
                  const handler = commandHandlers[s.cmd];
                  if (handler) {
                    //handler(svg, s); // svg doesnt have those methods, it needs to be a canvas context
                    d += s.cmd + ' ' + s.pts.map(pt => `${pt.x} ${pt.y}`).join(' '); // —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ d
                  } else {
                    console.warn('Unknown command:', s.cmd);
                  }
                });

                pathEl.setAttribute('d', d.trim());

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
                logEl.textContent = segments.map(s => `${s.cmd} ${s.pts.map(pt => `${pt.x.toFixed(1)} ${pt.y.toFixed(1)}`).join(' ')}`).join('\n');
              }

            function addPoint(x, y) {
                const last = segments.length ? segments[segments.length-1].pts.slice(-1)[0] : null;
                let pts = [];

                const createPts = {
                    'M': () => [{x, y}],
                    'L': () => last ? [{x: last.x, y: last.y}, {x, y}] : null,
                    'Q': () => last ? [
                        {x: last.x, y: last.y},
                        {x: (last.x + x) / 2, y: (last.y + y) / 2 - 50},
                        {x, y}
                    ] : null,
                    'C': () => last ? [
                        {x: last.x, y: last.y},
                        {x: last.x + (x - last.x) * 0.3, y: last.y + (y - last.y) * 0.3 - 30},
                        {x: last.x + (x - last.x) * 0.7, y: last.y + (y - last.y) * 0.7 + 30},
                        {x, y}
                    ] : null
                };

                const ptsCreator = createPts[currentMode];

                if (ptsCreator) {
                    pts = ptsCreator();
                    if (!pts) return;

                    segments.push({
                        cmd: currentMode,
                        pts: pts
                    });

                    redraw();
                } else {
                    console.warn('Unknown mode:', currentMode);
                }
            }

            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ SVG
            function createControlPoint(pt, type = '') {
                const circle = document.createElementNS(svgNS, "circle");
                circle.setAttribute('cx', pt.x);
                circle.setAttribute('cy', pt.y);
                circle.setAttribute('r', 5);
                circle.setAttribute('class', `control-point ${type}`);
                controlPointsGroup.appendChild(circle);

                let isDragging = false;
                let startX, startY;

                circle.addEventListener('mousedown', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    isDragging = true;
                    circle.classList.add('dragging');
                    startX = e.clientX - pt.x;
                    startY = e.clientY - pt.y;

                    const onMouseMove = e => {
                        if (!isDragging) return;
                        pt.x = e.clientX - startX;
                        pt.y = e.clientY - startY;
                        circle.setAttribute('cx', pt.x);
                        circle.setAttribute('cy', pt.y);
                        redraw();
                    };

                    const onMouseUp = () => {
                        isDragging = false;
                        circle.classList.remove('dragging');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });

                return circle;
            }

             function createHelperLine(pt1, pt2) {
                const line = document.createElementNS(svgNS, "line");
                line.setAttribute('x1', pt1.x);
                line.setAttribute('y1', pt1.y);
                line.setAttribute('x2', pt2.x);
                line.setAttribute('y2', pt2.y);
                line.setAttribute('class', 'helper-line');
                helperLinesGroup.appendChild(line);
                return line;
              }

            function clearControlPoints() {
                while (controlPointsGroup.firstChild) {
                    controlPointsGroup.removeChild(controlPointsGroup.firstChild);
                }
                while (helperLinesGroup.firstChild) {
                  helperLinesGroup.removeChild(helperLinesGroup.firstChild);
              }

            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π

            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫)
            toolsPanel.addEventListener('mousedown', (e) => {
                if (e.target === toolsPanel.querySelector('#toolsHeader')) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫–Ω—É–ª–∏ –∏–º–µ–Ω–Ω–æ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    isDraggingPanel = true;
                    panelOffsetX = e.clientX - toolsPanel.offsetLeft;
                    panelOffsetY = e.clientY - toolsPanel.offsetTop;
                    toolsPanel.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('mouseup', () => {
                isDraggingPanel = false;
                toolsPanel.style.cursor = 'move';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDraggingPanel) return;
                toolsPanel.style.left = (e.clientX - panelOffsetX) + 'px';
                toolsPanel.style.top = (e.clientY - panelOffsetY) + 'px';
            });
          window.addEventListener('resize', () => {
            canvas.setAttribute('width', window.innerWidth);
            canvas.setAttribute('height', window.innerHeight);
            svg.setAttribute('width', window.innerWidth);
            svg.setAttribute('height', window.innerHeight);
        });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            window.togglePanel = function () {
                const isHidden = toolsPanel.classList.contains('hidden');
                toolsPanel.classList.toggle('hidden');
                toggleBtn.classList.toggle('panelOpen');
                toggleBtn.textContent = isHidden ? '√ó' : '‚ò∞';

            };
            toggleBtn.onclick = togglePanel;
            //–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
                undoButton.addEventListener('click', () => {
                  //  undo();
                });
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
                clearPathButton.addEventListener('click', () => {
                    //clearPath();
                });

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                insertImageButton.addEventListener('click', () => {
                  const input = document.createElement('input');
                  input.type = 'file';
                  input.accept = 'image/*';
                  input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        if (!bgImage)
                            createBgImage();
                      bgImage.setAttribute('href', event.target.result);
                      bgImage.setAttribute('width', canvas.clientWidth);
                      bgImage.setAttribute('height', canvas.clientHeight);
                    };
                    reader.readAsDataURL(file);
                  };
                  input.click();
                });

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ–Ω–æ–º: –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ

           canvas.addEventListener('wheel', (e) => {
            if (isControllingBackground && bgImage) {
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                let scale = parseFloat(bgImage.getAttribute('scale') || 1); // –ù–∞—á–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–±
                const delta = e.deltaY > 0 ? -0.1 : 0.1; // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞
                scale += delta;
                scale = Math.max(0.1, Math.min(scale, 5)); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –æ—Ç 0.1 –¥–æ 5
                bgImage.setAttribute('transform', `scale(${scale})`); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±
                bgImage.setAttribute('scale', scale);  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞
            }
        });

        let isDraggingBg = false;
        let startXBg, startYBg;

        canvas.addEventListener('mousedown', (e) => {
            if (isControllingBackground && bgImage) {
                isDraggingBg = true;
                startXBg = e.clientX - parseFloat(bgImage.getAttribute('x') || 0);
                startYBg = e.clientY - parseFloat(bgImage.getAttribute('y') || 0);
                canvas.style.cursor = 'grabbing'; // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDraggingBg = false;
            canvas.style.cursor = 'default';
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isControllingBackground && isDraggingBg && bgImage) {
                const newX = e.clientX - startXBg;
                const newY = e.clientY - startYBg;

                bgImage.setAttribute('x', newX);
                bgImage.setAttribute('y', newY);
            }
        });


           toggleBgControlButton.addEventListener('click', () => {
            isControllingBackground = !isControllingBackground;
            toggleBgControlButton.classList.toggle('active', isControllingBackground);

            if (isControllingBackground) {
                canvas.style.cursor = 'grab'; // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä
            } else {
                canvas.style.cursor = 'default';
            }
           });

            // –ö–ª–∏–∫ –ø–æ SVG –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫

            canvas.addEventListener('click', e => {
                if (!isControllingBackground) { // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫–∏, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ–Ω–æ–º
                  const rect = canvas.getBoundingClientRect();
                  const x = e.clientX - rect.left;
                  const y = e.clientY - rect.top;

                  addPoint(x, y);
                }
            });

            // –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
            modeButtons.forEach(button => {
                button.addEventListener('click', e => {
                    currentMode = e.target.dataset.mode;
                    modeButtons.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ M –∏ –Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
            document.querySelector('[data-mode="M"]').classList.add('active');
            addPoint(50, 50); // –ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
        })();

    </script>
</body>
</html>
